# Optimized Compiler and flags
CC = clang

# Optimized Flags
CFLAGS = -D_POSIX_C_SOURCE=200809L -Wall -Wextra -O3\
         -march=native -mtune=native \
         -mprefer-vector-width=256 \
         -fno-align-jumps \
         -flto -fmerge-all-constants \
         -fvectorize -fslp-vectorize -funroll-loops \
         -ffp-contract=fast \
         -fomit-frame-pointer -fno-stack-protector \
         -ffunction-sections -fdata-sections \
         
LDFLAGS = -L./lib -lasound \
          -static \
          -flto -fuse-ld=lld \
          -Wl,--gc-sections \
          -Wl,--strip-all \
          -Wl,--icf=all \
          -Wl,-O3 \
          -Wl,--hash-style=gnu \
          -Wl,--build-id=none \
          -Wl,--sort-section=alignment
# ADD -Wl,--print-gc-sections to see what's being removed (optional)         


# Target and source
TARGET = bin/qua_player_32
SOURCE = src/qua_player_32.c

# Installation directories
PREFIX ?= /usr/local
BINDIR = $(PREFIX)/bin
SCRIPTS = qua_handler qua_setup
APPLICATIONSDIR = /usr/share/applications
DESKTOP_FILE = qua-audio-player.desktop
# Default target
all: $(TARGET)

# Debug flags
DEBUG_CFLAGS = -DDEBUG -g -O0

# Debug build
debug: CFLAGS = $(DEBUG_CFLAGS)
debug: TARGET = bin/qua_player_32_debug
debug: $(TARGET)

# Build rule
$(TARGET): $(SOURCE) | bin
	$(CC) $(CFLAGS) -o $(TARGET) $(SOURCE) $(LDFLAGS)

# Create bin directory
bin:
	mkdir -p bin

# Install target
install: $(TARGET)
	@echo "Installing Qua Audio Player..."
	install -d $(BINDIR)
	install -d $(APPLICATIONSDIR)
	install -m 755 $(TARGET) $(BINDIR)/
	install -m 755 $(SCRIPTS) $(BINDIR)/
	install -m 644 $(DESKTOP_FILE) $(APPLICATIONSDIR)/
	@echo "Updating desktop database..."
	-update-desktop-database $(APPLICATIONSDIR) 2>/dev/null || true
	@echo "Installation complete."

# Uninstall target
uninstall:
	@echo "Uninstalling Qua Audio Player..."
	rm -f $(addprefix $(BINDIR)/, $(SCRIPTS))
	rm -f $(BINDIR)/qua_player_32
	rm -f $(APPLICATIONSDIR)/$(DESKTOP_FILE)
	@echo "Updating desktop database..."
	-update-desktop-database $(APPLICATIONSDIR) 2>/dev/null || true
	@echo "Uninstallation complete"

# Clean target
clean:
	rm -f $(TARGET) bin/qua_player_32_debug

# Rebuild target
rebuild: clean all

# Mark targets as phony
.PHONY: all debug clean rebuild install uninstall
