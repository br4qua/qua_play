#!/bin/bash

# Configuration
BOLT="/usr/bin/llvm-bolt"
BIN_DIR="./bin"
AUDIO_DIR="./test-audio"
FDATA_NAME="qua_profile.fdata"
INSTALL_DIR="/usr/local/bin"

PGO_PREFIX=".pgo7"
BOLT_SUFFIX=".bolt3"
LAUNCHER="qua-bare-launcher"

TARGETS=(
    # 16-bit Targets
    "$BIN_DIR/qua-player-16-44100$PGO_PREFIX:$AUDIO_DIR/16bit_44100.wav"
    # 32-bit Targets
    "$BIN_DIR/qua-player-32-44100$PGO_PREFIX:$AUDIO_DIR/32bit_44100.wav"
    "$BIN_DIR/qua-player-32-48000$PGO_PREFIX:$AUDIO_DIR/32bit_48000.wav"
    "$BIN_DIR/qua-player-32-88000$PGO_PREFIX:$AUDIO_DIR/32bit_88000.wav"
    "$BIN_DIR/qua-player-32-96000$PGO_PREFIX:$AUDIO_DIR/32bit_96000.wav"
    "$BIN_DIR/qua-player-32-192000$PGO_PREFIX:$AUDIO_DIR/32bit_192000.wav"
)
# ------------------------------------------

# Check dependencies
if [ ! -x "$BOLT" ]; then
    echo "Error: llvm-bolt not found or not executable at $BOLT."
    exit 1
fi

mkdir -p "./tmp"
pkill -9 qua-signals

echo "--- Starting LLVM-BOLT PGO Build (Stable Flags) ---"

# Process targets from the explicit array
echo 0 | sudo tee /proc/sys/kernel/randomize_va_space
for TARGET in "${TARGETS[@]}"; do
    # Split the target string into binary and audio paths
    ORIG_BIN="${TARGET%%:*}"
    AUDIO_PATH="${TARGET##*:}"
    NAME=$(basename "$ORIG_BIN")
    
    # Check if the binary and audio file exist before starting the process
    if [ ! -f "$ORIG_BIN" ]; then
        echo "Skipping $NAME: Binary $ORIG_BIN not found."
        continue
    fi
    
    if [ ! -f "$AUDIO_PATH" ]; then
        echo "Skipping $NAME: Audio file $AUDIO_PATH not found."
        continue
    fi

    echo "Processing **$NAME**..."
    
    # Temporary files are placed in ./tmp
    INST_BIN="./tmp/$NAME.instrumented"
    FDATA_PATH="./tmp/$NAME.$FDATA_NAME" 
    NUKE_BIN="$ORIG_BIN$BOLT_SUFFIX" # Optimized output remains in ./bin
    
    # Cleanup any residual files from previous runs
    rm -f "$INST_BIN" "$FDATA_PATH"

    # 1. Instrumentation
    echo "  > 1. Instrumenting $NAME (Output: $INST_BIN)."
    "$BOLT" "$ORIG_BIN" -o "$INST_BIN" -instrument \
        --instrumentation-file="$FDATA_PATH" || { echo "Instrumentation failed."; continue; }

    # 2. Profiling (Removed taskset 0x10 for stability)
    echo "  > 2. Profiling with $AUDIO_PATH."
   "$LAUNCHER" 4 "$INST_BIN" "$AUDIO_PATH"
    
    if [ ! -f "$FDATA_PATH" ]; then
        echo "  > Warning: Skipping optimization. Profile data not generated (non-clean exit?)."
        rm -f "$INST_BIN"
        continue
    fi

   # 4. NUKE Optimization (Stable, High-Impact Flags)
   echo "  > 3. Applying NUKE optimization to $ORIG_BIN -> $NUKE_BIN (Stable Flags)"
    "$BOLT" "$ORIG_BIN" -o "$NUKE_BIN" -data "$FDATA_PATH" \
        --split-functions \
        --split-all-cold \
        --split-strategy=cdsplit \
        --reorder-functions=cdsort \
        --reorder-blocks=ext-tsp \
        --icf=none \
		--assume-abi \
        --peepholes=all \
        --eliminate-unreachable \
        --simplify-conditional-tail-calls \
        --dyno-stats \
        --lite=false \
        --reg-reassign \
    	--use-aggr-reg-reassign \
        --shorten-instructions \
        --frame-opt=all \
        --align-blocks \
        --x86-align-branch-boundary-hot-only \
        --x86-strip-redundant-address-size \
        --hot-data \
        --split-eh \
        --strip-rep-ret \
        --inline-ap \
        --inline-all \
        --inline-small-functions \
        --indirect-call-promotion=all \
        --simplify-rodata-loads \
        --use-edge-counts \
		--reorder-functions-use-hot-size \
        --cg-use-split-hot-size \
        --sctc-mode=always \
        --indirect-call-promotion-use-mispredicts \
        --use-compact-aligner \
        --strict=0 \
        --icp-eliminate-loads \
        --jump-tables=aggressive \
        --align-functions=64 \
        --plt=all \
        --hugify || echo "NUKE optimization failed."
        

    # 5. Cleanup
    # rm -f "$INST_BIN" "$FDATA_PATH"
    echo "  > Cleanup complete. Optimized binary is $NUKE_BIN"
    echo "---"

    # 6. Installation
    # Install with the suffix attached to the original name.
    if [ -f "$NUKE_BIN" ]; then
        INSTALL_NAME=$(basename "$NUKE_BIN")
        echo "  > 6. Installing $INSTALL_NAME to $INSTALL_DIR (requires sudo)..."
        sudo install -m 755 "$NUKE_BIN" "$INSTALL_DIR/$INSTALL_NAME"
        echo "  > Installation complete: $INSTALL_DIR/$INSTALL_NAME"
    fi
    echo "---"

done
echo 2 | sudo tee /proc/sys/kernel/randomize_va_space
echo "--- All BOLT processing finished. ---"
