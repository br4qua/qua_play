#!/usr/bin/env python3
import sys
try:
    import dbus
    import dbus.service
    from dbus.mainloop.glib import DBusGMainLoop
    from gi.repository import GLib
except ImportError as e:
    print(f"Error: Missing dependency - {e}", file=sys.stderr)
    print("Install: python3-dbus python3-gi", file=sys.stderr)
    sys.exit(1)

import subprocess
import os

print(f"DEBUG: Script PATH = {os.environ.get('PATH', 'NOT SET')}", file=sys.stderr, flush=True)


DBusGMainLoop(set_as_default=True)

class QuaMPRIS(dbus.service.Object):
    def __init__(self):
        bus_name = dbus.service.BusName('org.mpris.MediaPlayer2.qua', bus=dbus.SessionBus())
        dbus.service.Object.__init__(self, bus_name, '/org/mpris/MediaPlayer2')
    
    @dbus.service.method('org.mpris.MediaPlayer2.Player')
    def Next(self):
        print("MPRIS: Next() called", file=sys.stderr, flush=True)
        subprocess.run(['qua-next', '1'])
    
    @dbus.service.method('org.mpris.MediaPlayer2.Player')
    def Previous(self):
        print("MPRIS: Previous() called", file=sys.stderr, flush=True)
        subprocess.run(['qua-next', '-1'])
    
    @dbus.service.method('org.mpris.MediaPlayer2.Player')
    def Stop(self):
        print("MPRIS: Stop() called", file=sys.stderr, flush=True)
        subprocess.run(['qua-stop'])
    
    @dbus.service.method('org.mpris.MediaPlayer2.Player')
    def Play(self):
        print("MPRIS: Play() called", file=sys.stderr, flush=True)
        print(f"DEBUG: PATH in Play() = {os.environ.get('PATH', 'NOT SET')}", file=sys.stderr, flush=True)
        
        # Try to find qua-next
        import shutil
        qua_next_path = shutil.which('qua-next')
        print(f"DEBUG: which qua-next = {qua_next_path}", file=sys.stderr, flush=True)
        
        try:
            result = subprocess.run(['qua-next', '0'], capture_output=True, text=True)
            print(f"DEBUG: subprocess return code = {result.returncode}", file=sys.stderr, flush=True)
            print(f"DEBUG: subprocess stdout = {result.stdout}", file=sys.stderr, flush=True)
            print(f"DEBUG: subprocess stderr = {result.stderr}", file=sys.stderr, flush=True)
        except Exception as e:
            print(f"DEBUG: subprocess exception = {e}", file=sys.stderr, flush=True)
            import traceback
            traceback.print_exc()
    
    @dbus.service.method('org.mpris.MediaPlayer2.Player')
    def Pause(self):
        print("MPRIS: Pause() called", file=sys.stderr, flush=True)
        subprocess.run(['qua-stop', '0'])
    
    @dbus.service.method('org.mpris.MediaPlayer2.Player')
    def PlayPause(self):
        print("MPRIS: PlayPause() called", file=sys.stderr, flush=True)
        subprocess.run(['qua-stop', '0'])
        
    # URI support
    @dbus.service.method('org.mpris.MediaPlayer2.Player', in_signature='s')
    def OpenUri(self, uri):
        print(f"MPRIS: OpenUri() called with: '{uri}'", file=sys.stderr, flush=True)
        try:
            # Handle file:// URIs
            if uri.startswith('file://'):
                path = uri[7:]
            else:
                path = uri
            
            print(f"Writing path: '{path}'", file=sys.stderr, flush=True)
            
            filepath = '/tmp/qua-current-song'
            print(f"Writing to: {filepath}", file=sys.stderr, flush=True)
            
            # Write to file
            with open(filepath, 'w') as f:
                bytes_written = f.write(path)
                f.flush()
                print(f"Wrote {bytes_written} bytes", file=sys.stderr, flush=True)
            
            # Verify immediately after closing
            import os
            print(f"File size: {os.path.getsize(filepath)}", file=sys.stderr, flush=True)
            
            with open(filepath, 'r') as f:
                content = f.read()
                print(f"File contains {len(content)} chars: '{content}'", file=sys.stderr, flush=True)
            
            # DON'T call qua-next yet
            subprocess.run(['qua-next', '0'])
            
        except Exception as e:
            print(f"ERROR: {e}", file=sys.stderr, flush=True)
            import traceback
            traceback.print_exc()

    # Required MPRIS2 properties
    @dbus.service.method('org.freedesktop.DBus.Properties', in_signature='ss', out_signature='v')
    def Get(self, interface, prop):
        print(f"MPRIS: Get() called - interface: '{interface}', property: '{prop}'", file=sys.stderr, flush=True)
        if interface == 'org.mpris.MediaPlayer2.Player':
            if prop == 'PlaybackStatus':
                return 'Playing'
            if prop == 'CanControl':
                return True
            if prop == 'CanGoNext':
                return True
            if prop == 'CanGoPrevious':
                return True
            if prop == 'CanPlay':
                return True
            if prop == 'CanPause':
                return True
        elif interface == 'org.mpris.MediaPlayer2':
            if prop == 'Identity':
                return 'Qua'
            if prop == 'CanQuit':
                return False
            if prop == 'CanRaise':
                return False
        return dbus.String('')
    
    @dbus.service.method('org.freedesktop.DBus.Properties', in_signature='s', out_signature='a{sv}')
    def GetAll(self, interface):
        print(f"MPRIS: GetAll() called - interface: '{interface}'", file=sys.stderr, flush=True)
        if interface == 'org.mpris.MediaPlayer2.Player':
            return {
                'PlaybackStatus': 'Playing',
                'CanControl': True,
                'CanGoNext': True,
                'CanGoPrevious': True,
                'CanPlay': True,
                'CanPause': True,
            }
        elif interface == 'org.mpris.MediaPlayer2':
            return {
                'Identity': 'Qua',
                'CanQuit': False,
                'CanRaise': False,
            }
        return {}
    
    @dbus.service.method('org.mpris.MediaPlayer2')
    def Raise(self):
        print("MPRIS: Raise() called", file=sys.stderr, flush=True)
        pass
    
    @dbus.service.method('org.mpris.MediaPlayer2')
    def Quit(self):
        print("MPRIS: Quit() called", file=sys.stderr, flush=True)
        pass

if __name__ == '__main__':
    try:
        print("Starting qua MPRISx adapter...", file=sys.stderr)
        QuaMPRIS()
        print("qua registered on D-Bus", file=sys.stderr)
        loop = GLib.MainLoop()
        loop.run()
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)
